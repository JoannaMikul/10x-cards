---
import Layout from "../layouts/Layout.astro";
import { FlashcardsPage } from "../components/flashcards/FlashcardsPage.tsx";
import type { CategoryDTO, SourceDTO, TagDTO } from "../types";
import { supabaseClient } from "../db/supabase.client.ts";

const supabase = Astro.locals.supabase ?? supabaseClient;
const userId = Astro.locals.user?.id ?? null;

async function fetchCategories(): Promise<CategoryDTO[]> {
  const { data, error } = await supabase
    .from("categories")
    .select("id, name, slug, description, color, created_at, updated_at")
    .order("name", { ascending: true });

  if (error) {
    // eslint-disable-next-line no-console
    console.error("[flashcards] Failed to fetch categories", error);
    return [];
  }

  return (data ?? []) as CategoryDTO[];
}

type TagWithUsage = TagDTO & {
  card_tags?: { card_id: string }[] | null;
};

async function fetchTagsCatalog(): Promise<{ tags: TagDTO[]; filterTags: TagDTO[] }> {
  const { data, error } = await supabase
    .from("tags")
    .select("id, name, slug, description, created_at, updated_at, card_tags(card_id)")
    .order("name", { ascending: true });

  if (error) {
    // eslint-disable-next-line no-console
    console.error("[flashcards] Failed to fetch tags", error);
    return { tags: [], filterTags: [] };
  }

  const rows = (data ?? []) as TagWithUsage[];
  const tags = rows.map(stripCardTags);
  const filterTags = rows.filter((row) => (row.card_tags?.length ?? 0) > 0).map(stripCardTags);

  return { tags, filterTags };
}

function stripCardTags({ card_tags, ...tag }: TagWithUsage): TagDTO {
  void card_tags;
  return tag;
}

async function fetchSources(): Promise<SourceDTO[]> {
  const { data, error } = await supabase
    .from("sources")
    .select("id, name, slug, description, kind, url, created_at, updated_at")
    .order("name", { ascending: true });

  if (error) {
    // eslint-disable-next-line no-console
    console.error("[flashcards] Failed to fetch sources", error);
    return [];
  }

  return (data ?? []) as SourceDTO[];
}

async function fetchIsAdmin(): Promise<boolean> {
  if (!userId) {
    return false;
  }

  const { data, error } = await supabase.from("user_roles").select("role").eq("user_id", userId);

  if (error) {
    // eslint-disable-next-line no-console
    console.error("[flashcards] Failed to fetch user roles", error);
    return false;
  }

  return (data ?? []).some((role) => role.role === "admin");
}

export const prerender = false;

const [categories, tagsCatalog, sources, canShowDeleted] = await Promise.all([
  fetchCategories(),
  fetchTagsCatalog(),
  fetchSources(),
  fetchIsAdmin(),
]);

const { tags, filterTags } = tagsCatalog;
---

<Layout title="Flashcards - 10x-cards">
  <main class="min-h-[calc(100vh-3rem)] bg-background" data-testid="flashcards-page">
    <div class="mx-auto max-w-7xl">
      <FlashcardsPage client:load {categories} {tags} {sources} {canShowDeleted} {filterTags} />
    </div>
  </main>
</Layout>
