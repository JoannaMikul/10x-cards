name: Deploy to Cloudflare Pages

on:
  workflow_dispatch:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint, unit-test]
    environment: production
    env:
      SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      OPENROUTER_DEFAULT_MODE: ${{ vars.OPENROUTER_DEFAULT_MODE }}
      NODE_ENV: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create environment file
        run: |
          echo "SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}" > .env.production
          echo "SUPABASE_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}" >> .env.production
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> .env.production
          echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" >> .env.production
          echo "OPENROUTER_DEFAULT_MODEL=${{ vars.OPENROUTER_DEFAULT_MODEL }}" >> .env.production

      - name: Build application
        run: npm run build:production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/
          retention-days: 1

  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: build
    environment: production
    env:
      SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      OPENROUTER_DEFAULT_MODE: ${{ vars.OPENROUTER_DEFAULT_MODE }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/

      - name: Verify deployment configuration
        run: |
          echo "Checking required secrets and variables..."
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then echo "‚ùå CLOUDFLARE_API_TOKEN is not set"; exit 1; fi
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then echo "‚ùå CLOUDFLARE_ACCOUNT_ID is not set"; exit 1; fi
          if [ -z "$CLOUDFLARE_PROJECT_NAME" ]; then echo "‚ùå CLOUDFLARE_PROJECT_NAME is not set"; exit 1; fi
          echo "‚úÖ All required variables are set"
          echo "Project name: $CLOUDFLARE_PROJECT_NAME"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_PROJECT_NAME: ${{ vars.CLOUDFLARE_PROJECT_NAME }}

      - name: Install Wrangler CLI
        run: npm install -g wrangler@3.107.3

      - name: Deploy to Cloudflare Pages
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üöÄ Starting deployment..."
          echo "Project name: ${{ vars.CLOUDFLARE_PROJECT_NAME }}"
          echo "Wrangler version: $(wrangler --version)"
          echo "API Token present: $(if [ -n "$CLOUDFLARE_API_TOKEN" ]; then echo '‚úÖ Yes'; else echo '‚ùå No'; fi)"
          echo "Account ID present: $(if [ -n "$CLOUDFLARE_ACCOUNT_ID" ]; then echo '‚úÖ Yes'; else echo '‚ùå No'; fi)"

          # Run wrangler deployment
          wrangler pages deploy dist --project-name=${{ vars.CLOUDFLARE_PROJECT_NAME }}

          # Show wrangler logs if deployment failed
          WRANGLER_LOG_DIR="/home/runner/.config/.wrangler/logs"
          if [ -d "$WRANGLER_LOG_DIR" ]; then
            echo "üìã Wrangler logs:"
            find "$WRANGLER_LOG_DIR" -name "*.log" -exec tail -50 {} \;
          fi

      - name: Log deployment details
        if: always()
        run: |
          echo "Final deployment URL: ${{ steps.deploy.outputs.deployment-url }}"
